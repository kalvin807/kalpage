---
import { fetchPaintingPixels, CACHE_TTL_SECONDS } from '../lib/painting-pixels';
import type { PaintingPayload } from '../lib/painting-pixels';

Astro.response.headers.set(
  'Cache-Control',
  `public, max-age=0, s-maxage=${CACHE_TTL_SECONDS}, stale-while-revalidate=86400`,
);
Astro.response.headers.set(
  'CDN-Cache-Control',
  `public, s-maxage=${CACHE_TTL_SECONDS}, stale-while-revalidate=86400`,
);
Astro.response.headers.set(
  'Vercel-CDN-Cache-Control',
  `public, s-maxage=${CACHE_TTL_SECONDS}, stale-while-revalidate=86400`,
);

let error = false;
let result: PaintingPayload = { pixels: [], cols: 0, info: { title: '', artist: '', date: '', url: '' } };

try {
  result = await fetchPaintingPixels();
} catch {
  error = true;
}

const { pixels, cols, info } = result;
---

{error ? (
  <p class="painting-error">Could not load a painting this time.</p>
) : (
  <Fragment>
    <div class="painting-grid" style={`grid-template-columns:repeat(${cols},1fr)`}>
      {pixels.map(px => <div class="painting-pixel" style={`background:rgb(${px.r},${px.g},${px.b})`} />)}
    </div>
    <div class="painting-info">
      <a href={info.url} target="_blank" rel="noopener noreferrer" class="painting-link">
        <div class="painting-title">{info.title}</div>
        <div class="painting-artist">{[info.artist, info.date].filter(Boolean).join(' \u00b7 ')}</div>
      </a>
    </div>
  </Fragment>
)}
